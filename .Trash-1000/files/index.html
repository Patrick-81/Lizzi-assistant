<!-- Remplacer UNIQUEMENT cette section dans index.html -->
<!-- Onglet M√©moire - VERSION AM√âLIOR√âE -->
<div class="content-area" id="memoryTab">
  <style>
    /* Styles sp√©cifiques √† l'onglet M√©moire */
    .memory-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      padding: 20px 30px;
      background: white;
      border-bottom: 1px solid #e5e5e7;
    }

    body.dark-mode .memory-stats {
      background: #1a1a1a;
      border-bottom-color: #2a2a2a;
    }

    .stat-card-mini {
      text-align: center;
      padding: 12px;
      background: #fafafa;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .stat-card-mini:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    body.dark-mode .stat-card-mini {
      background: #252525;
    }

    .stat-value-mini {
      font-size: 24px;
      font-weight: 700;
      color: #007aff;
    }

    .stat-label-mini {
      font-size: 11px;
      color: #86868b;
      text-transform: uppercase;
      margin-top: 4px;
    }

    .memory-add-section {
      background: white;
      padding: 20px 30px;
      border-bottom: 1px solid #e5e5e7;
    }

    body.dark-mode .memory-add-section {
      background: #1a1a1a;
      border-bottom-color: #2a2a2a;
    }

    .memory-add-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #1d1d1f;
    }

    body.dark-mode .memory-add-title {
      color: #e5e5e7;
    }

    .spo-form {
      display: grid;
      grid-template-columns: 1.5fr 1.5fr 2fr auto;
      gap: 10px;
      align-items: end;
    }

    @media (max-width: 768px) {
      .spo-form {
        grid-template-columns: 1fr;
      }
    }

    .spo-input-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .spo-label {
      font-size: 12px;
      font-weight: 500;
      color: #86868b;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .spo-input {
      padding: 10px 14px;
      border: 1px solid #d2d2d7;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
      background: #fafafa;
    }

    .spo-input:focus {
      outline: none;
      border-color: #007aff;
      background: white;
    }

    body.dark-mode .spo-input {
      background: #0f0f0f;
      border-color: #3a3a3a;
      color: #e5e5e7;
    }

    body.dark-mode .spo-input:focus {
      background: #1a1a1a;
    }

    .memory-toolbar {
      padding: 15px 30px;
      background: white;
      border-bottom: 1px solid #e5e5e7;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    body.dark-mode .memory-toolbar {
      background: #1a1a1a;
      border-bottom-color: #2a2a2a;
    }

    .search-box {
      flex: 1;
      max-width: 400px;
      position: relative;
    }

    .search-icon-box {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #86868b;
      pointer-events: none;
    }

    .search-input-box {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border: 1px solid #d2d2d7;
      border-radius: 20px;
      font-size: 14px;
      background: #fafafa;
    }

    .search-input-box:focus {
      outline: none;
      border-color: #007aff;
      background: white;
    }

    body.dark-mode .search-input-box {
      background: #0f0f0f;
      border-color: #3a3a3a;
      color: #e5e5e7;
    }

    .toolbar-actions {
      display: flex;
      gap: 8px;
    }

    .tool-btn {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid #d2d2d7;
      border-radius: 6px;
      color: #1d1d1f;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tool-btn:hover {
      background: #f5f5f7;
      border-color: #007aff;
      color: #007aff;
    }

    body.dark-mode .tool-btn {
      border-color: #3a3a3a;
      color: #e5e5e7;
    }

    body.dark-mode .tool-btn:hover {
      background: #2a2a2a;
    }

    .facts-list {
      flex: 1;
      overflow-y: auto;
      padding: 20px 30px;
      background: #fafafa;
    }

    body.dark-mode .facts-list {
      background: #0f0f0f;
    }

    .triplet-item {
      background: white;
      padding: 16px;
      margin-bottom: 10px;
      border-radius: 10px;
      border: 1px solid #e5e5e7;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
      transition: all 0.2s;
    }

    .triplet-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transform: translateY(-1px);
    }

    body.dark-mode .triplet-item {
      background: #1a1a1a;
      border-color: #2a2a2a;
    }

    .triplet-display {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .triplet-part {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .part-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
      opacity: 0.5;
    }

    .part-value {
      font-size: 14px;
      font-weight: 500;
      word-break: break-word;
    }

    .subject-part .part-label { color: #667eea; }
    .subject-part .part-value { color: #667eea; }

    .predicate-part .part-label { color: #10b981; }
    .predicate-part .part-value { color: #10b981; }

    .object-part .part-label { color: #f59e0b; }
    .object-part .part-value { color: #f59e0b; }

    .separator {
      color: #d1d5db;
      font-size: 16px;
      flex-shrink: 0;
    }

    .triplet-btns {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .triplet-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      background: #f5f5f7;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 14px;
    }

    body.dark-mode .triplet-btn {
      background: #2a2a2a;
    }

    .triplet-btn-edit:hover {
      background: #dbeafe;
      color: #2563eb;
    }

    .triplet-btn-delete:hover {
      background: #fee2e2;
      color: #dc2626;
    }

    .empty-facts {
      text-align: center;
      padding: 60px 20px;
      color: #86868b;
    }

    .empty-icon-large {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.3;
    }

    .empty-title-large {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #1d1d1f;
    }

    body.dark-mode .empty-title-large {
      color: #e5e5e7;
    }

    .triplet-edit-mode {
      background: #f0f9ff !important;
      border-color: #3b82f6 !important;
    }

    body.dark-mode .triplet-edit-mode {
      background: #1e3a8a !important;
    }

    .edit-inline {
      padding: 6px 10px;
      border: 2px solid #3b82f6;
      border-radius: 6px;
      font-size: 13px;
      width: 100%;
      background: white;
    }

    body.dark-mode .edit-inline {
      background: #0f0f0f;
      color: #e5e5e7;
    }
  </style>

  <!-- Statistiques -->
  <div class="memory-stats">
    <div class="stat-card-mini">
      <div class="stat-value-mini" id="memTotalFacts">0</div>
      <div class="stat-label-mini">Faits totaux</div>
    </div>
    <div class="stat-card-mini">
      <div class="stat-value-mini" id="memTotalSubjects">0</div>
      <div class="stat-label-mini">Sujets</div>
    </div>
    <div class="stat-card-mini">
      <div class="stat-value-mini" id="memTotalPredicates">0</div>
      <div class="stat-label-mini">Relations</div>
    </div>
  </div>

  <!-- Formulaire d'ajout -->
  <div class="memory-add-section">
    <h3 class="memory-add-title">‚ûï Ajouter un nouveau fait</h3>
    <div class="spo-form">
      <div class="spo-input-group">
        <label class="spo-label">üîµ Sujet</label>
        <input type="text" class="spo-input" id="memInputSubject" placeholder="Patrick, Utilisateur...">
      </div>

      <div class="spo-input-group">
        <label class="spo-label">üü¢ Pr√©dicat</label>
        <input type="text" class="spo-input" id="memInputPredicate" placeholder="poss√®de, aime, habite...">
      </div>

      <div class="spo-input-group">
        <label class="spo-label">üü° Objet</label>
        <input type="text" class="spo-input" id="memInputObject" placeholder="un chat nomm√© Belf√©gor...">
      </div>

      <button class="send-btn" onclick="addMemoryFact()">Ajouter</button>
    </div>
  </div>

  <!-- Barre d'outils -->
  <div class="memory-toolbar">
    <div class="search-box">
      <span class="search-icon-box">üîç</span>
      <input
        type="text"
        class="search-input-box"
        id="memSearchInput"
        placeholder="Rechercher..."
        oninput="filterMemoryFacts()"
      >
    </div>
    <div class="toolbar-actions">
      <button class="tool-btn" onclick="exportMemoryFacts()">üì• Export</button>
      <button class="tool-btn" onclick="document.getElementById('memImportFile').click()">üì§ Import</button>
      <input type="file" id="memImportFile" accept=".json" style="display: none;" onchange="importMemoryFacts(event)">
    </div>
  </div>

  <!-- Liste des faits -->
  <div class="facts-list" id="memFactsList">
    <div class="empty-facts">
      <div class="empty-icon-large">üß†</div>
      <div class="empty-title-large">Chargement...</div>
    </div>
  </div>

  <script>
    let allMemoryFacts = [];
    let editingMemoryId = null;

    async function loadMemoryFacts() {
      try {
        const response = await fetch(`${API_URL}/api/facts`);
        const data = await response.json();
        allMemoryFacts = data.facts || [];
        updateMemoryStats();
        renderMemoryFacts(allMemoryFacts);
      } catch (error) {
        console.error('Erreur chargement m√©moire:', error);
      }
    }

    function updateMemoryStats() {
      document.getElementById('memTotalFacts').textContent = allMemoryFacts.length;

      const subjects = new Set(allMemoryFacts.map(f => f.subject || 'Utilisateur'));
      document.getElementById('memTotalSubjects').textContent = subjects.size;

      const predicates = new Set(allMemoryFacts.map(f => f.predicate || f.key));
      document.getElementById('memTotalPredicates').textContent = predicates.size;
    }

    function renderMemoryFacts(facts) {
      const container = document.getElementById('memFactsList');

      if (facts.length === 0) {
        container.innerHTML = `
          <div class="empty-facts">
            <div class="empty-icon-large">üì≠</div>
            <div class="empty-title-large">Aucun fait enregistr√©</div>
            <div style="font-size: 13px; margin-top: 4px;">Ajoutez votre premier fait ci-dessus</div>
          </div>
        `;
        return;
      }

      container.innerHTML = facts.map(fact => {
        const subject = fact.subject || 'Utilisateur';
        const predicate = fact.predicate || fact.key || '?';
        const object = fact.object || fact.value || '?';

        return `
          <div class="triplet-item" id="mem-card-${fact.id}">
            <div class="triplet-display">
              <div class="triplet-part subject-part">
                <div class="part-label">Sujet</div>
                <div class="part-value" id="mem-subject-${fact.id}">${escapeHtml(subject)}</div>
              </div>
              <span class="separator">‚Üí</span>
              <div class="triplet-part predicate-part">
                <div class="part-label">Pr√©dicat</div>
                <div class="part-value" id="mem-predicate-${fact.id}">${escapeHtml(predicate)}</div>
              </div>
              <span class="separator">‚Üí</span>
              <div class="triplet-part object-part">
                <div class="part-label">Objet</div>
                <div class="part-value" id="mem-object-${fact.id}">${escapeHtml(object)}</div>
              </div>
            </div>
            <div class="triplet-btns">
              <button class="triplet-btn triplet-btn-edit" onclick="startMemoryEdit('${fact.id}')" title="Modifier">‚úèÔ∏è</button>
              <button class="triplet-btn triplet-btn-delete" onclick="deleteMemoryFact('${fact.id}')" title="Supprimer">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function addMemoryFact() {
      const subject = document.getElementById('memInputSubject').value.trim();
      const predicate = document.getElementById('memInputPredicate').value.trim();
      const object = document.getElementById('memInputObject').value.trim();

      if (!subject || !predicate || !object) {
        alert('Tous les champs sont requis');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/facts`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subject,
            key: predicate,
            value: object
          })
        });

        if (response.ok) {
          document.getElementById('memInputSubject').value = '';
          document.getElementById('memInputPredicate').value = '';
          document.getElementById('memInputObject').value = '';
          await loadMemoryFacts();
        }
      } catch (error) {
        console.error('Erreur ajout:', error);
      }
    }

    function startMemoryEdit(id) {
      if (editingMemoryId) cancelMemoryEdit();

      editingMemoryId = id;
      const card = document.getElementById(`mem-card-${id}`);
      card.classList.add('triplet-edit-mode');

      const fact = allMemoryFacts.find(f => f.id === id);

      const subject = fact.subject || 'Utilisateur';
      const predicate = fact.predicate || fact.key || '';
      const object = fact.object || fact.value || '';

      document.getElementById(`mem-subject-${id}`).innerHTML =
        `<input type="text" class="edit-inline" id="mem-edit-subject-${id}" value="${escapeHtml(subject)}">`;
      document.getElementById(`mem-predicate-${id}`).innerHTML =
        `<input type="text" class="edit-inline" id="mem-edit-predicate-${id}" value="${escapeHtml(predicate)}">`;
      document.getElementById(`mem-object-${id}`).innerHTML =
        `<input type="text" class="edit-inline" id="mem-edit-object-${id}" value="${escapeHtml(object)}">`;

      card.querySelector('.triplet-btns').innerHTML = `
        <button class="triplet-btn" onclick="saveMemoryEdit('${id}')" style="background: #10b981; color: white;">‚úì</button>
        <button class="triplet-btn" onclick="cancelMemoryEdit()" style="background: #ef4444; color: white;">‚úï</button>
      `;
    }

    async function saveMemoryEdit(id) {
      const subject = document.getElementById(`mem-edit-subject-${id}`).value.trim();
      const predicate = document.getElementById(`mem-edit-predicate-${id}`).value.trim();
      const object = document.getElementById(`mem-edit-object-${id}`).value.trim();

      if (!subject || !predicate || !object) {
        alert('Tous les champs sont requis');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/facts/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subject,
            key: predicate,
            value: object
          })
        });

        if (response.ok) {
          editingMemoryId = null;
          await loadMemoryFacts();
        }
      } catch (error) {
        console.error('Erreur modification:', error);
      }
    }

    function cancelMemoryEdit() {
      editingMemoryId = null;
      renderMemoryFacts(allMemoryFacts);
    }

    async function deleteMemoryFact(id) {
      if (!confirm('Supprimer ce fait ?')) return;

      try {
        const response = await fetch(`${API_URL}/api/facts/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          await loadMemoryFacts();
        }
      } catch (error) {
        console.error('Erreur suppression:', error);
      }
    }

    function filterMemoryFacts() {
      const query = document.getElementById('memSearchInput').value.toLowerCase();

      const filtered = allMemoryFacts.filter(fact => {
        const subject = (fact.subject || '').toLowerCase();
        const predicate = (fact.predicate || fact.key || '').toLowerCase();
        const object = (fact.object || fact.value || '').toLowerCase();

        return subject.includes(query) ||
               predicate.includes(query) ||
               object.includes(query);
      });

      renderMemoryFacts(filtered);
    }

    function exportMemoryFacts() {
      const dataStr = JSON.stringify(allMemoryFacts, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `lizzi-memory-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    }

    function importMemoryFacts(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const imported = JSON.parse(e.target.result);

          for (const fact of imported) {
            await fetch(`${API_URL}/api/facts`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                subject: fact.subject,
                key: fact.predicate || fact.key,
                value: fact.object || fact.value
              })
            });
          }

          alert(`${imported.length} fait(s) import√©(s)`);
          await loadMemoryFacts();
        } catch (error) {
          alert('Erreur lors de l\'import');
        }
      };
      reader.readAsText(file);
    }
  </script>
</div>
